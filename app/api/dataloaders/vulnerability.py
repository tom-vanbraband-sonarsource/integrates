from promise import Promise
from promise.dataloader import DataLoader

from app.domain import vulnerability as vuln_domain
from app.entity.vulnerability import Vulnerability


def batch_load_fn(ids):
    vulnerabilities = [
        Vulnerability(
            id=vuln.get('UUID', ''),
            finding_id=vuln.get('finding_id', ''),
            vuln_type=vuln.get('vuln_type', ''),
            where=vuln.get('where', ''),
            specific=vuln.get('specific', ''),
            historic_state=vuln.get('historic_state', [{}]),
            current_state=vuln.get('current_state', ''),
            treatment=vuln.get('treatment'),
            external_bts=vuln.get('external_bts', ''),
            treatment_justification=vuln.get('treatment_justification', ''),
            treatment_manager=vuln.get('treatment_manager', '')
        )
        for vuln in vuln_domain.list_vulnerabilities(ids)]

    return Promise.resolve(vulnerabilities)


class VulnerabilityLoader(DataLoader):
    def __init__(self):
        super(VulnerabilityLoader, self).__init__(batch_load_fn=batch_load_fn)
