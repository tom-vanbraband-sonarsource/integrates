from collections import OrderedDict

from django.test import TestCase
from django.test.client import RequestFactory
from django.contrib.sessions.middleware import SessionMiddleware
from django.conf import settings
from graphene.test import Client
from jose import jwt

from app.api.schema import SCHEMA


class VulnerabilityTests(TestCase):

    def test_get_vulnerability(self):
        """Check for vulnerabilities"""
        query = '''
            query {
                finding(identifier: "422286126") {
                id
                releaseDate
                portsVulns: vulnerabilities(
                    vulnType: "ports") {
                    ...vulnInfo
                }
                linesVulns: vulnerabilities(
                    vulnType: "lines") {
                    ...vulnInfo
                }
                inputsVulns: vulnerabilities(
                    vulnType: "inputs") {
                    ...vulnInfo
                }
                }
            }
            fragment vulnInfo on Vulnerability {
                vulnType
                where
                specific
                currentState
                id
                findingId
                treatment
                treatmentManager
                treatmentJustification
                externalBts
            }'''
        request = RequestFactory().get('/')
        middleware = SessionMiddleware()
        middleware.process_request(request)
        request.session.save()
        request.session['username'] = "unittest"
        request.session['company'] = "unittest"
        request.session['role'] = "admin"
        request.COOKIES[settings.JWT_COOKIE_NAME] = jwt.encode(
            {
                'user_email': 'unittest',
                'user_role': 'admin',
                'company': 'unittest'
            },
            algorithm='HS512',
            key=settings.JWT_SECRET,
        )
        result = SCHEMA.execute(query, context_value=request)
        assert not result.errors
        assert result.data.get('finding')['id'] == '422286126'
        test_data = OrderedDict([
            ('vulnType', u'inputs'),
            ('where', u'https://example.com'),
            ('specific', u'phone'),
            ('currentState', u'open'),
            ('id', u'80d6a69f-a376-46be-98cd-2fdedcffdcc0'),
            ('findingId', '422286126'),
            ('treatment', u'In progress'),
            ('treatmentManager', u'continuoushacking@gmail.com'),
            ('treatmentJustification', u'Test 123'),
            ('externalBts', '')])
        assert test_data in result.data.get('finding')['inputsVulns']

    def test_remove_vulnerability(self):
        """check for remove_vulnerability"""
        test_client = Client(SCHEMA)
        query = '''
            mutation{
                deleteVulnerability (
                id: "39db67dd-dec8-4957-b9c0-fc5a6f2aee03"
                findingId: "475041513"
                ) {
                success
                }
            }
        '''
        request = RequestFactory().get('/')
        middleware = SessionMiddleware()
        middleware.process_request(request)
        request.session.save()
        request.session['username'] = 'unittest'
        request.session['company'] = 'unittest'
        request.session['role'] = 'admin'
        request.COOKIES[settings.JWT_COOKIE_NAME] = jwt.encode(
            {
                'user_email': 'unittest',
                'user_role': 'admin',
                'company': 'unittest'
            },
            algorithm='HS512',
            key=settings.JWT_SECRET,
        )
        result = test_client.execute(query, context_value=request)
        assert 'errors' not in result
        assert 'success' in result['data']['deleteVulnerability']
