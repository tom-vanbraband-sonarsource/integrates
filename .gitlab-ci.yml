stages:
  - deps-base
  - build-apps
  - deps
  - rotation
  - build
  - test
  - mr-check
  - deploy-infra
  - deploy-app
  - post-deploy

deps-mobile:
  stage: deps-base
  tags: [autoscaling-large]
  image: fluidattacks/docker-bash:latest
  script:
    - ./ci-scripts/jobs/deps-mobile.sh
  interruptible: true

deps-base:
  stage: deps-base
  tags: [autoscaling]
  image: fluidattacks/docker-bash:latest
  script:
    - ./ci-scripts/jobs/deps-base.sh
  interruptible: true

django-apps:
  stage: build-apps
  needs: [deps-base]
  tags: [autoscaling]
  image: registry.gitlab.com/fluidattacks/integrates/deps-base:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/build-django-apps.sh
  interruptible: true
  artifacts:
    expire_in: 1 day
    paths:
      - django-apps/packages/
    when: on_success

build-lambdas:
    stage: build-apps
    needs: [deps-base]
    tags: [autoscaling]
    image: registry.gitlab.com/fluidattacks/integrates/deps-base:$CI_COMMIT_REF_NAME
    script:
        - ./ci-scripts/jobs/build-lambdas.sh
    retry: 1
    artifacts:
        expire_in: 1 day
        paths:
        - lambda/packages/
        when: on_success

deps-production:
  stage: deps
  needs: [deps-base]
  tags: [autoscaling]
  image: fluidattacks/docker-bash:latest
  script:
    - ./ci-scripts/jobs/deps-production.sh
  interruptible: true

deps-development:
  stage: deps
  needs: [deps-base]
  tags: [autoscaling]
  image: fluidattacks/docker-bash:latest
  script:
    - ./ci-scripts/jobs/deps-development.sh
  interruptible: true

build-back:
  stage: build
  needs: [deps-development,django-apps]
  tags: [autoscaling-large]
  image: fluidattacks/docker-bash:latest
  script:
    - ./ci-scripts/jobs/build-app.sh
  retry: 1
  artifacts:
    expire_in: 1 day
    paths:
    - version.txt
    when: on_success

build-front:
  stage: build
  needs: [deps-development,django-apps]
  tags: [autoscaling-large]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/build-front.sh
  retry: 1
  artifacts:
    expire_in: 1 day
    paths:
    - app/assets/
    when: on_success

test-front:
  stage: test
  tags: [autoscaling-large]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/test-front.sh
  artifacts:
    name: "coverage_lcov_${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHA:0:8}"
    paths:
      - front/coverage.lcov
    expire_in: 1 week
  only:
    - branches
    - merge_requests
  interruptible: true

test-mobile:
  stage: test
  tags: [autoscaling-large]
  needs: [deps-mobile]
  image: registry.gitlab.com/fluidattacks/integrates/deps-mobile:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/test-mobile.sh
  interruptible: true

test-back:
  stage: test
  tags: [autoscaling-large]
  image: registry.gitlab.com/fluidattacks/integrates/app:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/test-app.sh
  artifacts:
    name: "coverage_xml_${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHA:0:8}"
    paths:
      - coverage.xml
    expire_in: 1 week
  only:
    - branches
    - merge_requests
  except:
    - master
  interruptible: true

lint-back:
  stage: test
  tags: [autoscaling]
  needs: [build-back]
  image: registry.gitlab.com/fluidattacks/integrates/app:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/lint-app.sh
  only:
    - branches
  except:
    - master
  interruptible: true

asserts-static:
  stage: test
  tags: [autoscaling]
  needs: [deps-development]
  image:
    name: fluidattacks/break-build
    entrypoint: [""]
  before_script:
    - docker pull fluidattacks/break-build
  script:
    - bash <(docker run fluidattacks/break-build
              --static
              --id ${BREAK_BUILD_ID}
              --secret ${BREAK_BUILD_SECRET}
              --gitlab-docker-socket-binding
             ) || true
  except:
    - master
  interruptible: true

commitlint:
  stage: test
  tags: [autoscaling]
  image: starefossen/ruby-node:2-10
  script:
    - npm install --unsafe-perm
    - ./ci-scripts/jobs/commitlint.sh

danger:
  stage: mr-check
  tags: [autoscaling]
  image: fluidattacks/danger-ruby
  dependencies:
    - terraform-resources-plan
    - secret-management-dev-terraform-plan
  script:
    - ./ci-scripts/jobs/danger.sh
  only:
    - merge_requests

coverage-report:
  stage: mr-check
  tags: [autoscaling]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  dependencies:
    - test-back
    - test-front
  script:
    - ./ci-scripts/jobs/coverage-report.sh
  retry: 1
  only:
    - merge_requests
  except:
    - master

deploy-back-ephemeral:
  stage: deploy-app
  tags: [autoscaling]
  needs: [build-back]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - ./review-apps/cluster-config.sh
  retry: 1
  environment:
    name: "review/$CI_COMMIT_REF_SLUG"
    url: "https://$CI_COMMIT_REF_SLUG.$CI_PROJECT_NAME.env.fluidattacks.com/integrates"
    on_stop: stop-ephemeral-app
  except:
    - master

stop-ephemeral-app:
  stage: deploy-app
  tags: [autoscaling]
  image: registry.gitlab.com/fluidattacks/integrates/app:$CI_COMMIT_REF_NAME
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  script:
    - ./ci-scripts/jobs/stop-ephemeral-app.sh
  retry: 1
  when: manual
  except:
    - master

deploy-front:
  stage: deploy-app
  tags: [autoscaling]
  needs: [build-front]
  image: registry.gitlab.com/fluidattacks/integrates/app:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/deploy-front.sh

deploy-back:
  stage: deploy-app
  tags: [autoscaling]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  environment:
    name: "production"
    url: "https://fluidattacks.com/integrates"
  script:
    - ./ci-scripts/jobs/deploy-k8s.sh
  only:
    - master

deploy-mobile:
  stage: deploy-app
  tags: [autoscaling-large]
  needs: [deps-mobile]
  image: registry.gitlab.com/fluidattacks/integrates/deps-mobile:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/deploy-mobile.sh
  environment:
    name: "mobile-review/$CI_COMMIT_REF_NAME"
    url: "https://expo.io/@developmentatfluid/integrates?release-channel=$CI_COMMIT_REF_NAME"

.deploy-playstore:
  stage: deploy-app
  image: registry.gitlab.com/fluidattacks/integrates/deps-mobile:$CI_COMMIT_REF_NAME
  dependencies:
    - deps-mobile
  script:
    - ./ci-scripts/jobs/deploy-playstore.sh
  allow_failure: true
  only:
    - master

test-driver-dev:
  stage: post-deploy
  tags: [autoscaling-large]
  needs: [deploy-back-ephemeral]
  image: registry.gitlab.com/fluidattacks/integrates/app:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/test-driver.sh
  parallel: 5
  retry: 1
  artifacts:
    name: "regression_${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHA:0:8}"
    paths:
      - screenshots/
    when: always
  except:
    - master
  interruptible: true

test-driver-prod:
  stage: post-deploy
  tags: [autoscaling-large]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:master
  script:
    - pip3 install -U django-apps/packages/*.zip
    - ./ci-scripts/jobs/test-driver.sh
  parallel: 5
  retry: 1
  artifacts:
    name: "regression_${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHA:0:8}"
    paths:
      - screenshots/
    when: always
  only:
    - master
  interruptible: true

asserts-dynamic:
  stage: post-deploy
  tags: [autoscaling]
  image:
    name: fluidattacks/break-build
    entrypoint: [""]
  before_script:
    - docker pull fluidattacks/break-build
  script:
    - bash <(docker run fluidattacks/break-build
              --dynamic
              --id ${BREAK_BUILD_ID}
              --secret ${BREAK_BUILD_SECRET}
              --gitlab-docker-socket-binding
             ) || true
  only:
    - master
  interruptible: true

new-version-mail:
  stage: post-deploy
  tags: [autoscaling]
  image: registry.gitlab.com/fluidattacks/integrates/app:$CI_COMMIT_REF_NAME
  dependencies:
    - build-back
  script:
    - pip3 install -U gitpython wheel mandrill-really-maintained
    - ./ci-scripts/jobs/new-version-mail.sh
  only:
    - master
  except:
    - schedules

clean-registry-caches:
  stage: post-deploy
  tags: [autoscaling]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/clean-registry-caches.sh
  only:
    - schedules

rotate-jwt-token:
  stage: rotation
  tags: [autoscaling]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/rotate-jwt-token.sh
  only:
    - schedules

renew-review-certificate:
  stage: post-deploy
  tags: [autoscaling]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - ./ci-scripts/jobs/renew-review-certificate.sh
  environment:
    name: "review/renew-review-cert"
    auto_stop_in: 1 hour
  only:
    - schedules

terraform-resources-apply:
  stage: deploy-infra
  tags: [autoscaling]
  needs: [terraform-resources-plan, terraform-resources-lint]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/terraform-resources.sh
    - terraform_resources_apply
  only:
    - master

terraform-resources-lint:
  stage: test
  tags: [autoscaling]
  needs: [deps-development]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/terraform-resources.sh
    - terraform_resources_lint
  interruptible: true

terraform-resources-plan:
  stage: test
  tags: [autoscaling]
  needs: [deps-development]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/terraform-resources.sh
    - terraform_resources_plan
  artifacts:
    paths:
      - plan.txt
    expire_in: 1h
    when: on_success
  interruptible: true

secret-management-dev-terraform-apply:
  stage: deploy-infra
  tags: [autoscaling]
  needs: [secret-management-dev-terraform-plan, secret-management-dev-terraform-lint]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/secret-management-dev.sh
    - secret_management_dev_terraform_apply
  only:
    - master

secret-management-dev-terraform-lint:
  stage: test
  tags: [autoscaling]
  needs: [deps-development]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/secret-management-dev.sh
    - secret_management_dev_terraform_lint
  interruptible: true

secret-management-dev-terraform-plan:
  stage: test
  tags: [autoscaling]
  needs: [deps-development]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/secret-management-dev.sh
    - secret_management_dev_terraform_plan
  interruptible: true

secret-management-prod-terraform-apply:
  stage: deploy-infra
  tags: [autoscaling]
  needs: [secret-management-prod-terraform-plan, secret-management-prod-terraform-lint]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/secret-management-prod.sh
    - secret_management_prod_terraform_apply
  only:
    - master

secret-management-prod-terraform-lint:
  stage: test
  tags: [autoscaling]
  needs: [deps-development]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/secret-management-prod.sh
    - secret_management_prod_terraform_lint
  only:
    - master
  interruptible: true

secret-management-prod-terraform-plan:
  stage: test
  tags: [autoscaling]
  needs: [deps-development]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/secret-management-prod.sh
    - secret_management_prod_terraform_plan
  only:
    - master
  interruptible: true

aws-sso-terraform-apply:
  stage: deploy-infra
  tags: [autoscaling]
  needs: [aws-sso-terraform-lint, aws-sso-terraform-plan]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/aws-sso.sh
    - aws_sso_terraform_apply
  only:
    - master

aws-sso-terraform-lint:
  stage: test
  tags: [autoscaling]
  needs: [deps-development]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/aws-sso.sh
    - aws_sso_terraform_lint
  only:
    - master
  interruptible: true

aws-sso-terraform-plan:
  stage: test
  tags: [autoscaling]
  needs: [deps-development]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/aws-sso.sh
    - aws_sso_terraform_plan
  only:
    - master
  interruptible: true

backup-terraform-apply:
  stage: deploy-infra
  tags: [autoscaling]
  needs: [backup-terraform-test]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/backup.sh
    - backup_terraform_apply
  only:
    - master

backup-terraform-test:
  stage: test
  tags: [autoscaling]
  needs: [deps-development]
  image: registry.gitlab.com/fluidattacks/integrates/deps-development:$CI_COMMIT_REF_NAME
  script:
    - . ci-scripts/jobs/backup.sh
    - backup_terraform_test
  interruptible: true
