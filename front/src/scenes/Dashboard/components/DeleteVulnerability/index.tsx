/* tslint:disable jsx-no-multiline-js
 * JSX-NO-MULTILINE-JS: Disabling this rule is necessary for the sake of
 * readability of the code that dynamically renders the fields
 */
import _ from "lodash";
import React from "react";
import { Mutation, MutationFn, MutationResult } from "react-apollo";
import { ButtonToolbar, ControlLabel, FormGroup } from "react-bootstrap";
import { Field, submit } from "redux-form";
import { Button } from "../../../../components/Button/index";
import { Modal } from "../../../../components/Modal/index";
import { dispatch } from "../../../../store/index";
import { hidePreloader, showPreloader } from "../../../../utils/apollo";
import { handleGraphQLErrors } from "../../../../utils/formatHelpers";
import { dropdownField } from "../../../../utils/forms/fields";
import translate from "../../../../utils/translations/translate";
import { required } from "../../../../utils/validations";
import { GenericForm } from "../GenericForm";
import { DELETE_VULN_MUTATION } from "./queries";
import { IDeleteVulnAttr, IDeleteVulnerabilityProps } from "./types";

const renderDeleteVulnerabilityForm: ((props: IDeleteVulnerabilityProps) => JSX.Element) =
  (props: IDeleteVulnerabilityProps): JSX.Element => {
    const handleDeleteResult: ((data: IDeleteVulnAttr) => void) = (data: IDeleteVulnAttr): void => {
      props.onDeleteVulnRes(data);
    };

    return (
    <Mutation mutation={DELETE_VULN_MUTATION} onCompleted={handleDeleteResult}>
    {(deleteVulnerability: MutationFn<IDeleteVulnAttr, {findingId: string; id: string; justification: string}>,
      mutationRes: MutationResult): React.ReactNode => {
      if (mutationRes.loading) {
        showPreloader();
      }
      if (!_.isUndefined(mutationRes.error)) {
        hidePreloader();
        handleGraphQLErrors("An error occurred deleting vulnerabilities", mutationRes.error);

        return <React.Fragment/>;
      }
      const handleDelete: ((values: { justification: string }) => void) =
      (values: { justification: string }): void => {
        deleteVulnerability({ variables:
          {findingId: props.findingId, id: props.id, justification: values.justification}})
          .catch();
      };

      return (
        <GenericForm name="deleteVulnerability" onSubmit={handleDelete}>
          <FormGroup>
            <ControlLabel>{translate.t("search_findings.delete.justif.label")}</ControlLabel>
            <Field name="justification" component={dropdownField} validate={[required]}>
              <option value="" />
              <option value="CHANGE_EVIDENCE">
                {translate.t("search_findings.delete.justif.evidence_change")}</option>
              <option value="FINDING_CHANGED">
                {translate.t("search_findings.delete.justif.finding_change")}</option>
              <option value="NOT_VULNERABILITY">
                {translate.t("search_findings.delete.justif.not_vuln")}</option>
              <option value="DUPLICATED">
                {translate.t("search_findings.delete.justif.duplicated")}</option>
            </Field>
          </FormGroup>
        </GenericForm>
      );
    }}
    </Mutation>
  );
  };

export const deleteVulnerabilityModal: React.FC<IDeleteVulnerabilityProps> =
(props: IDeleteVulnerabilityProps): JSX.Element => {
  const handleCloseModal: (() => void) = (): void => {
    props.onClose();
  };
  const onConfirmDelete: (() => void) = (): void => {
    dispatch(submit("deleteVulnerability"));
  };

  return (
  <React.StrictMode>
    <Modal
      open={props.open}
      headerTitle={translate.t("delete_vulns.title")}
      content={renderDeleteVulnerabilityForm(props)}
      footer={
        <ButtonToolbar className="pull-right">
          <Button bsStyle="default" onClick={handleCloseModal}>
            {translate.t("confirmmodal.cancel")}
          </Button>
          <Button bsStyle="default" onClick={onConfirmDelete}>
            {translate.t("confirmmodal.proceed")}
          </Button>
        </ButtonToolbar>
      }
    />
  </React.StrictMode>
  );
};
