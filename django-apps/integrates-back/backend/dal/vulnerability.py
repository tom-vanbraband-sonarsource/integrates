"""DAL functions for vulnerabilities."""

import rollbar
from boto3.dynamodb.conditions import Key
from botocore.exceptions import ClientError

from backend.dal.helpers import dynamodb

DYNAMODB_RESOURCE = dynamodb.DYNAMODB_RESOURCE
TABLE = DYNAMODB_RESOURCE.Table('FI_vulnerabilities')


def get_vulnerabilities(finding_id):
    """Get vulnerabilities of the given finding"""
    filter_exp = Key('finding_id').eq(finding_id)
    response = TABLE.query(KeyConditionExpression=filter_exp)
    vulns = response.get('Items', [])
    while 'LastEvaluatedKey' in response:
        response = TABLE.query(
            KeyConditionExpression=filter_exp,
            ExclusiveStartKey=response['LastEvaluatedKey'])
        vulns += response.get('Items', [])

    return vulns


def update(finding_id, vuln_id, data):
    success = False
    try:
        attrs_to_remove = [attr for attr in data if data[attr] is None]
        for attr in attrs_to_remove:
            response = TABLE.update_item(
                Key={'finding_id': finding_id, 'UUID': vuln_id},
                UpdateExpression='REMOVE #attr',
                ExpressionAttributeNames={'#attr': attr}
            )
            success = response['ResponseMetadata']['HTTPStatusCode'] == 200
            del data[attr]

        if data:
            attributes = ['#{attr} = :{attr}'.format(attr=attr)
                          for attr in data]
            values = {':{}'.format(attr): data[attr] for attr in data}

            response = TABLE.update_item(
                Key={'finding_id': finding_id, 'UUID': vuln_id},
                UpdateExpression='SET {}'.format(','.join(attributes)),
                ExpressionAttributeNames={
                    '#{}'.format(attr): attr for attr in data
                },
                ExpressionAttributeValues=values)
            success = response['ResponseMetadata']['HTTPStatusCode'] == 200
    except ClientError as ex:
        rollbar.report_message('Error: Couldn\'nt update vulnerability',
                               'error', extra_data=ex, payload_data=locals())

    return success


def update_state(finding_id, vuln_id, attr_name, attr_value, item):
    resp = False
    try:
        if attr_name not in item[0]:
            TABLE.update_item(
                Key={
                    'finding_id': str(finding_id),
                    'UUID': vuln_id,
                },
                UpdateExpression='SET #attrName = :val1',
                ExpressionAttributeNames={
                    '#attrName': attr_name
                },
                ExpressionAttributeValues={
                    ':val1': []
                }
            )
        update_response = TABLE.update_item(
            Key={
                'finding_id': str(finding_id),
                'UUID': vuln_id
            },
            UpdateExpression='SET #attrName = list_append(#attrName, :val1)',
            ExpressionAttributeNames={
                '#attrName': attr_name
            },
            ExpressionAttributeValues={
                ':val1': attr_value
            }
        )
        resp = update_response['ResponseMetadata']['HTTPStatusCode'] == 200
    except ClientError:
        rollbar.report_exc_info()
    return resp


def create(data):
    """Add vulnerabilities."""
    resp = False
    try:
        response = TABLE.put_item(
            Item={
                'finding_id': str(data.get('finding_id')),
                'UUID': str(data.get('UUID')),
                'vuln_type': data.get('vuln_type'),
                'where': data.get('where'),
                'specific': str(data.get('specific')),
                'historic_state': data.get('historic_state')
            }
        )
        resp = response['ResponseMetadata']['HTTPStatusCode'] == 200
    except ClientError:
        rollbar.report_exc_info()
    return resp


def delete(uuid, finding_id):
    """Delete a vulnerability of a finding."""
    resp = False
    try:
        response = TABLE.delete_item(
            Key={
                'UUID': uuid,
                'finding_id': finding_id
            }
        )
        resp = response['ResponseMetadata']['HTTPStatusCode'] == 200
    except ClientError:
        rollbar.report_exc_info()
    return resp
