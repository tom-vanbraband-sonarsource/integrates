from collections import defaultdict

from promise import Promise
from promise.dataloader import DataLoader

from backend.domain import vulnerability as vuln_domain
from backend.entity.vulnerability import Vulnerability


def _batch_load_fn(finding_ids):
    """Batches the data load requests within the same execution fragment"""
    vulnerabilities = defaultdict(list)

    for vuln in vuln_domain.list_vulnerabilities(finding_ids):
        vulnerabilities[vuln['finding_id']].append(
            Vulnerability(
                id=vuln.get('UUID', ''),
                finding_id=vuln.get('finding_id', ''),
                vuln_type=vuln.get('vuln_type', ''),
                where=vuln.get('where', ''),
                specific=vuln.get('specific', ''),
                historic_state=vuln.get('historic_state', [{}]),
                current_state=vuln.get(
                    'historic_state', [{}])[-1].get('state', ''),
                current_approval_status=vuln.get(
                    'historic_state', [{}])[-1].get('approval_status', ''),
                last_analyst=vuln_domain.get_last_approved_analyst(vuln),
                analyst=vuln.get(
                    'historic_state', [{}])[-1].get('analyst', ''),
                last_approved_status=vuln_domain.get_last_approved_status(
                    vuln),
                remediated=vuln.get(
                    'historic_verification', [{}])[-1].get('status') == 'REQUESTED',
                acceptance_date=vuln.get('acceptance_date', ''),
                severity=vuln.get('severity', ''),
                tags=vuln.get('tag', []),
                treatment=vuln.get('treatment'),
                external_bts=vuln.get('external_bts', ''),
                treatment_justification=vuln.get(
                    'treatment_justification', ''),
                treatment_manager=vuln.get('treatment_manager', ''),
                verification=vuln.get(
                    'historic_verification', [{}])[-1].get('status', '').capitalize(),
            )
        )

    return Promise.resolve([vulnerabilities.get(finding_id, [])
                            for finding_id in finding_ids])


class VulnerabilityLoader(DataLoader):
    def __init__(self):
        super(VulnerabilityLoader, self).__init__(batch_load_fn=_batch_load_fn)
